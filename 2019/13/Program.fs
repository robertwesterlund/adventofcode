// Learn more about F# at http://fsharp.org

open System

let input = [|1L;380L;379L;385L;1008L;2151L;871073L;381L;1005L;381L;12L;99L;109L;2152L;1102L;1L;0L;383L;1101L;0L;0L;382L;21001L;382L;0L;1L;20102L;1L;383L;2L;21102L;37L;1L;0L;1106L;0L;578L;4L;382L;4L;383L;204L;1L;1001L;382L;1L;382L;1007L;382L;36L;381L;1005L;381L;22L;1001L;383L;1L;383L;1007L;383L;21L;381L;1005L;381L;18L;1006L;385L;69L;99L;104L;-1L;104L;0L;4L;386L;3L;384L;1007L;384L;0L;381L;1005L;381L;94L;107L;0L;384L;381L;1005L;381L;108L;1106L;0L;161L;107L;1L;392L;381L;1006L;381L;161L;1102L;1L;-1L;384L;1106L;0L;119L;1007L;392L;34L;381L;1006L;381L;161L;1101L;0L;1L;384L;21002L;392L;1L;1L;21102L;1L;19L;2L;21102L;0L;1L;3L;21102L;1L;138L;0L;1106L;0L;549L;1L;392L;384L;392L;20101L;0L;392L;1L;21102L;19L;1L;2L;21102L;3L;1L;3L;21101L;161L;0L;0L;1106L;0L;549L;1101L;0L;0L;384L;20001L;388L;390L;1L;21001L;389L;0L;2L;21102L;1L;180L;0L;1105L;1L;578L;1206L;1L;213L;1208L;1L;2L;381L;1006L;381L;205L;20001L;388L;390L;1L;20101L;0L;389L;2L;21102L;205L;1L;0L;1105L;1L;393L;1002L;390L;-1L;390L;1101L;1L;0L;384L;20102L;1L;388L;1L;20001L;389L;391L;2L;21101L;228L;0L;0L;1105L;1L;578L;1206L;1L;261L;1208L;1L;2L;381L;1006L;381L;253L;21002L;388L;1L;1L;20001L;389L;391L;2L;21101L;0L;253L;0L;1105L;1L;393L;1002L;391L;-1L;391L;1101L;1L;0L;384L;1005L;384L;161L;20001L;388L;390L;1L;20001L;389L;391L;2L;21102L;1L;279L;0L;1105L;1L;578L;1206L;1L;316L;1208L;1L;2L;381L;1006L;381L;304L;20001L;388L;390L;1L;20001L;389L;391L;2L;21102L;304L;1L;0L;1105L;1L;393L;1002L;390L;-1L;390L;1002L;391L;-1L;391L;1102L;1L;1L;384L;1005L;384L;161L;21002L;388L;1L;1L;20101L;0L;389L;2L;21102L;0L;1L;3L;21101L;338L;0L;0L;1106L;0L;549L;1L;388L;390L;388L;1L;389L;391L;389L;21001L;388L;0L;1L;20102L;1L;389L;2L;21101L;0L;4L;3L;21102L;1L;365L;0L;1105L;1L;549L;1007L;389L;20L;381L;1005L;381L;75L;104L;-1L;104L;0L;104L;0L;99L;0L;1L;0L;0L;0L;0L;0L;0L;180L;16L;16L;1L;1L;18L;109L;3L;22101L;0L;-2L;1L;21201L;-1L;0L;2L;21102L;1L;0L;3L;21101L;414L;0L;0L;1105L;1L;549L;22102L;1L;-2L;1L;21201L;-1L;0L;2L;21102L;429L;1L;0L;1106L;0L;601L;1202L;1L;1L;435L;1L;386L;0L;386L;104L;-1L;104L;0L;4L;386L;1001L;387L;-1L;387L;1005L;387L;451L;99L;109L;-3L;2105L;1L;0L;109L;8L;22202L;-7L;-6L;-3L;22201L;-3L;-5L;-3L;21202L;-4L;64L;-2L;2207L;-3L;-2L;381L;1005L;381L;492L;21202L;-2L;-1L;-1L;22201L;-3L;-1L;-3L;2207L;-3L;-2L;381L;1006L;381L;481L;21202L;-4L;8L;-2L;2207L;-3L;-2L;381L;1005L;381L;518L;21202L;-2L;-1L;-1L;22201L;-3L;-1L;-3L;2207L;-3L;-2L;381L;1006L;381L;507L;2207L;-3L;-4L;381L;1005L;381L;540L;21202L;-4L;-1L;-1L;22201L;-3L;-1L;-3L;2207L;-3L;-4L;381L;1006L;381L;529L;22101L;0L;-3L;-7L;109L;-8L;2106L;0L;0L;109L;4L;1202L;-2L;36L;566L;201L;-3L;566L;566L;101L;639L;566L;566L;1201L;-1L;0L;0L;204L;-3L;204L;-2L;204L;-1L;109L;-4L;2106L;0L;0L;109L;3L;1202L;-1L;36L;593L;201L;-2L;593L;593L;101L;639L;593L;593L;21001L;0L;0L;-2L;109L;-3L;2105L;1L;0L;109L;3L;22102L;21L;-2L;1L;22201L;1L;-1L;1L;21101L;383L;0L;2L;21101L;0L;250L;3L;21101L;756L;0L;4L;21101L;630L;0L;0L;1106L;0L;456L;21201L;1L;1395L;-2L;109L;-3L;2105L;1L;0L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;1L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;1L;1L;0L;0L;0L;2L;2L;0L;2L;0L;0L;0L;0L;0L;0L;2L;2L;0L;2L;2L;0L;2L;2L;0L;0L;2L;2L;2L;0L;0L;0L;0L;2L;2L;2L;0L;1L;1L;0L;0L;0L;0L;2L;0L;2L;2L;0L;0L;2L;2L;0L;0L;2L;2L;0L;0L;2L;2L;2L;2L;0L;2L;0L;2L;2L;2L;2L;0L;2L;0L;0L;0L;1L;1L;0L;0L;2L;2L;0L;0L;0L;0L;0L;0L;2L;2L;2L;0L;0L;0L;0L;0L;2L;0L;2L;0L;0L;0L;0L;0L;2L;0L;2L;2L;0L;2L;0L;0L;1L;1L;0L;0L;0L;2L;0L;0L;0L;2L;0L;0L;0L;0L;0L;0L;0L;2L;0L;0L;2L;0L;2L;0L;0L;0L;0L;0L;0L;0L;2L;2L;2L;0L;2L;0L;1L;1L;0L;0L;2L;2L;2L;2L;0L;0L;0L;0L;0L;0L;0L;0L;0L;2L;0L;0L;0L;2L;2L;0L;0L;0L;2L;0L;0L;0L;2L;0L;2L;2L;2L;0L;1L;1L;0L;0L;0L;0L;2L;2L;2L;2L;2L;0L;2L;0L;0L;0L;0L;2L;0L;2L;0L;2L;0L;2L;0L;0L;2L;2L;0L;2L;0L;2L;0L;2L;0L;0L;1L;1L;0L;2L;2L;0L;2L;2L;2L;2L;0L;2L;2L;2L;2L;0L;0L;2L;0L;0L;2L;0L;2L;0L;0L;0L;2L;0L;0L;2L;2L;2L;0L;0L;0L;0L;1L;1L;0L;0L;2L;0L;0L;2L;2L;0L;0L;0L;0L;2L;2L;0L;0L;2L;0L;0L;0L;2L;2L;0L;2L;0L;2L;2L;0L;2L;2L;0L;0L;0L;2L;0L;1L;1L;0L;0L;0L;0L;0L;0L;0L;2L;0L;0L;0L;2L;0L;2L;0L;0L;0L;2L;2L;2L;2L;0L;2L;2L;0L;2L;2L;0L;0L;0L;2L;0L;0L;0L;1L;1L;0L;0L;0L;0L;0L;0L;0L;0L;2L;2L;2L;0L;0L;0L;0L;2L;0L;2L;0L;0L;0L;0L;2L;2L;0L;2L;2L;2L;0L;0L;2L;0L;2L;0L;1L;1L;0L;0L;0L;0L;2L;2L;0L;2L;2L;0L;2L;0L;2L;2L;2L;0L;0L;2L;2L;0L;0L;0L;0L;0L;0L;2L;0L;2L;2L;2L;0L;2L;2L;0L;1L;1L;0L;2L;0L;0L;2L;0L;0L;0L;0L;0L;2L;0L;0L;2L;2L;0L;2L;2L;2L;0L;2L;2L;0L;0L;2L;2L;0L;0L;2L;2L;0L;0L;2L;0L;1L;1L;0L;2L;0L;2L;0L;2L;0L;2L;0L;0L;2L;2L;0L;0L;2L;0L;0L;0L;2L;0L;2L;2L;0L;2L;0L;0L;0L;2L;0L;2L;2L;0L;2L;0L;1L;1L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;1L;1L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;4L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;1L;1L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;1L;1L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;1L;1L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;3L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;1L;1L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;0L;1L;52L;20L;53L;45L;54L;10L;5L;35L;28L;96L;68L;78L;29L;94L;94L;57L;42L;27L;61L;91L;60L;22L;54L;59L;33L;71L;63L;62L;97L;30L;76L;40L;87L;10L;30L;83L;68L;41L;63L;55L;24L;65L;56L;57L;21L;91L;17L;7L;60L;94L;34L;54L;75L;10L;16L;88L;32L;34L;41L;36L;57L;39L;14L;89L;23L;47L;7L;94L;89L;60L;56L;36L;44L;77L;29L;17L;93L;55L;58L;62L;61L;18L;50L;54L;22L;75L;45L;1L;29L;64L;32L;97L;98L;50L;37L;64L;39L;61L;23L;39L;61L;85L;85L;10L;37L;56L;84L;13L;43L;91L;20L;73L;77L;34L;87L;33L;36L;42L;48L;3L;39L;6L;18L;58L;38L;63L;48L;38L;96L;32L;72L;51L;22L;37L;76L;4L;95L;17L;3L;79L;89L;19L;12L;22L;71L;98L;95L;22L;82L;31L;70L;98L;48L;46L;6L;80L;95L;98L;1L;81L;27L;91L;14L;98L;13L;46L;21L;6L;75L;59L;73L;9L;52L;6L;44L;92L;9L;11L;65L;71L;19L;52L;84L;71L;38L;60L;43L;10L;78L;25L;22L;27L;90L;4L;23L;96L;19L;42L;54L;80L;63L;64L;26L;29L;58L;75L;35L;95L;38L;48L;1L;47L;61L;20L;74L;39L;85L;33L;10L;70L;90L;39L;93L;61L;9L;65L;19L;56L;84L;59L;57L;30L;76L;19L;52L;66L;89L;93L;19L;86L;4L;67L;59L;37L;28L;71L;1L;21L;40L;18L;92L;72L;57L;63L;88L;42L;17L;92L;42L;88L;93L;17L;19L;26L;63L;31L;1L;8L;76L;62L;31L;49L;36L;18L;19L;63L;50L;50L;13L;77L;22L;45L;11L;92L;7L;92L;69L;66L;49L;34L;2L;58L;61L;4L;18L;26L;20L;7L;51L;84L;81L;38L;72L;22L;83L;92L;16L;97L;20L;81L;25L;74L;13L;84L;71L;2L;81L;35L;83L;6L;73L;93L;60L;47L;2L;98L;27L;55L;68L;59L;67L;63L;61L;48L;65L;28L;71L;56L;39L;30L;93L;96L;3L;47L;93L;77L;11L;28L;86L;79L;90L;83L;39L;21L;68L;2L;49L;50L;78L;68L;81L;97L;49L;9L;44L;79L;31L;69L;81L;76L;93L;17L;31L;66L;46L;26L;18L;1L;17L;72L;1L;28L;47L;15L;85L;50L;95L;75L;52L;86L;5L;35L;59L;51L;41L;88L;33L;9L;7L;77L;1L;46L;6L;40L;39L;36L;52L;10L;12L;34L;87L;64L;13L;23L;96L;15L;89L;13L;64L;65L;29L;27L;28L;50L;57L;91L;68L;97L;5L;38L;57L;28L;45L;6L;10L;90L;7L;26L;79L;89L;93L;74L;77L;58L;51L;86L;75L;49L;80L;80L;28L;94L;11L;56L;36L;69L;88L;50L;10L;22L;77L;51L;83L;47L;53L;2L;46L;33L;45L;44L;23L;4L;28L;62L;21L;88L;61L;58L;72L;16L;4L;6L;47L;25L;37L;46L;72L;65L;74L;9L;69L;60L;62L;39L;82L;63L;17L;4L;79L;43L;68L;80L;17L;20L;20L;49L;59L;70L;5L;3L;69L;44L;95L;38L;90L;11L;98L;76L;36L;59L;80L;74L;85L;1L;46L;19L;97L;14L;89L;96L;14L;65L;68L;13L;90L;13L;46L;24L;39L;63L;73L;84L;46L;66L;92L;84L;56L;86L;44L;33L;23L;6L;91L;13L;25L;75L;76L;31L;68L;4L;40L;83L;51L;85L;70L;84L;27L;71L;40L;53L;75L;59L;77L;79L;98L;90L;33L;94L;63L;19L;65L;44L;90L;18L;71L;17L;72L;40L;32L;16L;43L;16L;55L;28L;93L;76L;68L;40L;25L;1L;11L;79L;42L;49L;46L;80L;14L;41L;75L;10L;84L;67L;94L;91L;83L;51L;41L;78L;57L;75L;10L;71L;33L;47L;69L;34L;5L;81L;26L;82L;39L;51L;55L;38L;23L;2L;87L;54L;45L;3L;34L;44L;65L;54L;5L;74L;3L;51L;18L;42L;37L;52L;20L;57L;80L;66L;91L;66L;62L;38L;56L;36L;77L;18L;27L;55L;97L;43L;53L;25L;92L;14L;55L;87L;91L;81L;33L;65L;12L;18L;76L;21L;77L;90L;40L;35L;36L;30L;87L;32L;12L;86L;10L;93L;49L;12L;25L;44L;15L;37L;11L;57L;2L;2L;16L;21L;58L;35L;77L;26L;15L;86L;49L;62L;57L;90L;8L;10L;81L;35L;85L;25L;76L;76L;61L;40L;69L;9L;34L;59L;29L;16L;71L;41L;61L;87L;62L;17L;37L;51L;14L;59L;67L;66L;65L;87L;4L;85L;82L;98L;48L;17L;9L;92L;12L;71L;871073L|]

[<EntryPoint>]
let main argv =
    
    input |> 
        Computer.Context.CreateFromDataArray |> 
        Computer.runProgram |> 
        (fun c -> 
            c.HasHalted |> printfn "Has halted: %b"
            c.OutputStream
        ) |>
        List.chunkBySize 3 |>
        List.fold (fun context numbers -> Arcade.PaintByNumbers numbers context) Arcade.Context.Empty |>
        (fun c -> c.Screen) |>
        Map.filter (fun k v ->
            match v with
            | Arcade.Block -> true
            | _ -> false
        ) |>
        Map.count |>
        printfn "Number of blocks: %i"

    let playGame computerContext =
        let rec playUntilHalted arcadeContext computerContext =
            let newComputerContext = computerContext |> Computer.runProgram
            let newArcadeContext = 
                newComputerContext.OutputStream |>
                    List.chunkBySize 3 |>
                    List.fold (fun context numbers -> Arcade.PaintByNumbers numbers context) arcadeContext
            newArcadeContext |> Arcade.Draw
            match newComputerContext.HasHalted with
            | true -> newArcadeContext
            | false -> 
                let ballPosition = 
                    newArcadeContext.Screen |> 
                        Map.tryFindKey (fun _ v -> 
                            match v with 
                            | Arcade.Ball -> true
                            | _ -> false
                        )
                let paddlePosition = 
                    newArcadeContext.Screen |> 
                        Map.tryFindKey (fun _ v -> 
                            match v with 
                            | Arcade.HorizontalPaddle -> true
                            | _ -> false
                        )
                match ballPosition with 
                | None -> playUntilHalted newArcadeContext { newComputerContext with OutputStream = []; InputStream = [0L]}
                | Some ball ->
                    match paddlePosition with 
                    | None ->playUntilHalted newArcadeContext { newComputerContext with OutputStream = []; InputStream = [0L]}
                    | Some paddle ->
                        match ball.X - paddle.X with
                        | res when res < 0L -> playUntilHalted newArcadeContext { newComputerContext with OutputStream = []; InputStream = [-1L]}
                        | res when res > 0L -> playUntilHalted newArcadeContext { newComputerContext with OutputStream = []; InputStream = [1L]}
                        | _ -> playUntilHalted newArcadeContext { newComputerContext with OutputStream = []; InputStream = [0L]}
        playUntilHalted Arcade.Context.Empty computerContext
    [
        [|2L|]
        (input |> Array.skip 1)
    ] |>
        Array.concat |>
        Computer.Context.CreateFromDataArray |>
        playGame |>
        (fun a -> a.Score) |>
        printfn "Total score: %i"

    printfn "Hello World from F#!"
    0 // return an integer exit code
